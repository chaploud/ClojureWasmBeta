# Clojure トークンパターン完全リスト

> 本家LispReader.java、公式ドキュメント、CLIテストから抽出
> 最終更新: 2026-01-25

---

## 概要

Clojureのリーダーは以下の層構造:

```
1. ホワイトスペース・コメント処理
2. マクロテーブル（単一文字 → リーダー関数）
3. ディスパッチマクロ（# + 文字 → リーダー関数）
4. 数値判定（正規表現マッチ）
5. シンボル/キーワード判定
6. タグ付きリテラル
```

---

## 1. 数値リテラル

### 1.1 整数

| パターン | 説明 | 例 |
|---------|------|-----|
| `[0-9]+` | 十進整数 | `42`, `0`, `123` |
| `-[0-9]+` | 負の整数 | `-42` |
| `+[0-9]+` | 明示的正の整数 | `+42` |
| `0x[0-9A-Fa-f]+` | 十六進 | `0x2A`, `0xFF` |
| `0[0-7]+` | 八進 | `052`, `0777` |
| `[2-36]r[0-9A-Za-z]+` | 基数指定 | `2r101010`, `36rZZ` |
| `[0-9]+N` | BigInt | `999999999999999N` |

**本家正規表現:**
```java
"([-+]?)(?:(0)|([1-9][0-9]*)|0[xX]([0-9A-Fa-f]+)|0([0-7]+)|([1-9][0-9]?)[rR]([0-9A-Za-z]+)|0[0-9]+)(N)?"
```

**型決定ロジック:**
- 64bit以内 → `Long`
- 64bit超 or `N`サフィックス → `BigInt`

### 1.2 浮動小数点

| パターン | 説明 | 例 |
|---------|------|-----|
| `[0-9]+.[0-9]*` | 小数 | `3.14`, `1.0`, `1.` |
| `[0-9]+e[+-]?[0-9]+` | 科学記法 | `1e10`, `1.5e-3` |
| `[0-9]+.[0-9]*e[+-]?[0-9]+` | 小数+科学記法 | `1.5e10` |
| `...M` | BigDecimal | `3.14M` |

**本家正規表現:**
```java
"([-+]?[0-9]+(\\.[0-9]*)?([eE][-+]?[0-9]+)?)(M)?"
```

### 1.3 有理数（Ratio）

| パターン | 説明 | 例 |
|---------|------|-----|
| `[0-9]+/[0-9]+` | 有理数 | `22/7`, `1/2` |
| `-[0-9]+/[0-9]+` | 負の有理数 | `-3/4` |

**本家正規表現:**
```java
"([-+]?[0-9]+)/([0-9]+)"
```

**処理:** `Numbers.divide()` で自動約分

### 1.4 特殊数値

| トークン | 値 |
|---------|-----|
| `##Inf` | 正の無限大 |
| `##-Inf` | 負の無限大 |
| `##NaN` | 非数 |

---

## 2. 文字列リテラル

### 2.1 基本文字列

```
"..."
```

**エスケープシーケンス:**

| シーケンス | 意味 |
|-----------|------|
| `\t` | タブ |
| `\r` | キャリッジリターン |
| `\n` | 改行 |
| `\\` | バックスラッシュ |
| `\"` | ダブルクォート |
| `\b` | バックスペース |
| `\f` | フォームフィード |
| `\uXXXX` | Unicode（4桁十六進） |
| `\oXXX` | 八進（1-3桁、0-377） |

**例:**
```clojure
"hello"
"line1\nline2"
"unicode\u0041"  ; → "unicodeA"
"octal\101"      ; → "octalA"
```

### 2.2 複数行文字列

```clojure
"line1
line2
line3"
```

改行はそのまま保持される。

---

## 3. 文字リテラル

### 3.1 基本文字

| パターン | 例 |
|---------|-----|
| `\X` | `\a`, `\A`, `\;` |

### 3.2 名前付き文字

| トークン | 値 |
|---------|-----|
| `\newline` | 改行 |
| `\space` | スペース |
| `\tab` | タブ |
| `\backspace` | バックスペース |
| `\formfeed` | フォームフィード |
| `\return` | キャリッジリターン |

### 3.3 Unicode文字

| パターン | 説明 | 例 |
|---------|------|-----|
| `\uXXXX` | Unicode（4桁固定） | `\u0041` → `A` |

### 3.4 八進文字

| パターン | 説明 | 例 |
|---------|------|-----|
| `\oXXX` | 八進（1-3桁、0-377） | `\o101` → `A` |

---

## 4. シンボル

### 4.1 基本シンボル

**有効な文字:**
- 先頭: アルファベット、`*`, `+`, `!`, `-`, `_`, `?`, `>`, `<`, `=`, `$`
- 後続: 上記 + 数字、`'`, `:`（一部）

**例:**
```clojure
foo
my-symbol
+plus+
*dynamic*
!bang!
->arrow
valid?
```

### 4.2 名前空間付きシンボル

```clojure
ns/name
clojure.core/map
my.ns/my-fn
```

### 4.3 特殊シンボル

| シンボル | 評価結果 |
|---------|---------|
| `nil` | `null` |
| `true` | `Boolean.TRUE` |
| `false` | `Boolean.FALSE` |

### 4.4 シンボル正規表現

```java
"[:]?([\\D&&[^/]].*/)?(/|[\\D&&[^/]][^/]*)"
```

---

## 5. キーワード

### 5.1 基本キーワード

```clojure
:foo
:my-keyword
:kebab-case
```

### 5.2 名前空間付きキーワード

```clojure
:ns/name
:user/foo
:clojure.core/refer
```

### 5.3 自動解決キーワード

| パターン | 説明 | 例 |
|---------|------|-----|
| `::name` | 現在のNSに解決 | `::foo` → `:user/foo` |
| `::alias/name` | エイリアスに解決 | `::str/join` → `:clojure.string/join` |

---

## 6. コレクションリテラル

### 6.1 リスト

```clojure
()           ; 空リスト
(1 2 3)
(+ 1 2)
(nested (list))
```

### 6.2 ベクトル

```clojure
[]           ; 空ベクトル
[1 2 3]
[:a :b :c]
[[1 2] [3 4]]
```

### 6.3 マップ

```clojure
{}           ; 空マップ
{:a 1 :b 2}
{"key" "value"}
{1 "one" 2 "two"}
```

**制約:** 要素数は偶数でなければならない

### 6.4 セット

```clojure
#{}          ; 空セット
#{1 2 3}
#{:a :b :c}
```

### 6.5 名前空間付きマップ

| パターン | 説明 | 例 |
|---------|------|-----|
| `#:ns{...}` | 明示的NS | `#:person{:name "Bob"}` → `{:person/name "Bob"}` |
| `#::{...}` | 現在のNS | `#::{:name "Bob"}` → `{:user/name "Bob"}` |
| `#::alias{...}` | エイリアス | `#::p{:name "Bob"}` → `{:person/name "Bob"}` |

---

## 7. リーダーマクロ（単一文字）

### 7.1 マクロテーブル

| 文字 | 名前 | 展開 | 例 |
|------|------|------|-----|
| `'` | Quote | `(quote x)` | `'foo` → `(quote foo)` |
| `` ` `` | Syntax Quote | 複雑な展開 | `` `foo`` → `user/foo` |
| `~` | Unquote | 評価 | `` `~x`` |
| `~@` | Unquote-splicing | 展開 | `` `(~@xs)`` |
| `@` | Deref | `(deref x)` | `@atom` → `(deref atom)` |
| `^` | Meta | メタデータ付与 | `^:tag x` |
| `;` | Comment | 行末まで無視 | `; comment` |
| `%` | Arg | fn内引数 | `%`, `%1`, `%&` |

### 7.2 区切り文字

| 文字 | 開始 | 終了 |
|------|------|------|
| `(` | リスト開始 | `)` |
| `[` | ベクトル開始 | `]` |
| `{` | マップ開始 | `}` |

### 7.3 Quote詳細

```clojure
'x           ; → (quote x)
'(1 2 3)     ; → (quote (1 2 3))
'{:a 1}      ; → (quote {:a 1})
```

### 7.4 Syntax Quote詳細

```clojure
`x           ; → user/x（NS修飾）
`(+ 1 2)     ; → (clojure.core/seq (clojure.core/concat ...))
`~x          ; → xの値
`~@xs        ; → xsの要素を展開
`foo#        ; → foo__1234__auto__（gensym）
```

### 7.5 Meta詳細

```clojure
^:tag x          ; → (with-meta x {:tag true})
^String x        ; → (with-meta x {:tag String})
^{:a 1 :b 2} x   ; → (with-meta x {:a 1 :b 2})
```

---

## 8. ディスパッチマクロ（#）

### 8.1 ディスパッチテーブル

| パターン | 名前 | 説明 |
|---------|------|------|
| `#'` | Var | `(var x)` |
| `#"..."` | Regex | 正規表現 |
| `#(...)` | Fn | 無名関数 |
| `#{...}` | Set | セット |
| `#_` | Discard | フォーム破棄 |
| `##` | Symbolic | 特殊数値 |
| `#:` | NS Map | 名前空間マップ |
| `#?` | Conditional | 条件読み込み |
| `#=` | Eval | 読み込み時評価 |
| `#!` | Comment | シェバン/コメント |
| `#^` | Meta | メタデータ（古い形式） |
| `#<` | Unreadable | エラー |
| `#tag` | Tagged | タグ付きリテラル |

### 8.2 正規表現

```clojure
#"[a-z]+"
#"\d{3}-\d{4}"
#"(?i)hello"     ; フラグ付き
```

### 8.3 無名関数

| パターン | 意味 |
|---------|------|
| `%` | 第1引数（`%1`と同じ） |
| `%1`, `%2`, ... | 第N引数 |
| `%&` | 残り引数 |

```clojure
#(+ % 1)         ; → (fn [x] (+ x 1))
#(+ %1 %2)       ; → (fn [x y] (+ x y))
#(apply + %&)    ; → (fn [& args] (apply + args))
```

### 8.4 フォーム破棄

```clojure
(+ 1 #_2 3)      ; → (+ 1 3)
#_#_a b c        ; → c（2つ破棄）
```

### 8.5 条件読み込み

```clojure
#?(:clj  (java-specific)
   :cljs (js-specific)
   :default nil)

#?@(:clj [1 2 3])  ; splicing版
```

**フィーチャーキー:**
- `:clj` - Clojure (JVM)
- `:cljs` - ClojureScript
- `:cljr` - Clojure CLR
- `:default` - フォールバック

### 8.6 タグ付きリテラル

**組み込み:**

| タグ | 型 | 例 |
|-----|-----|-----|
| `#inst` | java.util.Date | `#inst "2024-01-01T00:00:00.000Z"` |
| `#uuid` | java.util.UUID | `#uuid "550e8400-e29b-41d4-a716-446655440000"` |

**カスタム:**
```clojure
;; data_readers.cljで定義
{foo/bar my.ns/parse-bar}

;; 使用
#foo/bar [1 2 3]
```

### 8.7 評価リーダー（危険）

```clojure
#=(+ 1 2)        ; → 3（読み込み時評価）
```

**注意:** セキュリティリスクあり、`*read-eval*`で制御

---

## 9. ホワイトスペースと区切り

### 9.1 ホワイトスペース

| 文字 | 説明 |
|------|------|
| ` ` | スペース |
| `\t` | タブ |
| `\n` | 改行 |
| `\r` | キャリッジリターン |
| `,` | カンマ（ホワイトスペース扱い） |

### 9.2 トークン終了文字

以下の文字でトークンが終了:
- ホワイトスペース
- `"`, `;`, `@`, `^`, `` ` ``, `~`, `(`, `)`, `[`, `]`, `{`, `}`, `\`, `%`

---

## 10. エッジケースと注意点

### 10.1 `+` と `-` の曖昧性

```clojure
+42          ; → 数値 42
+foo         ; → シンボル +foo
-17          ; → 数値 -17
->>          ; → シンボル（スレッドマクロ）
```

**判定ロジック:** 次の文字が数字なら数値、それ以外ならシンボル

### 10.2 `/` シンボル

```clojure
/            ; → シンボル / (clojure.core//)
a/b          ; → 名前空間付きシンボル
```

### 10.3 ドット関連

```clojure
.method      ; → シンボル（Javaメソッド呼び出し）
..           ; → シンボル（連鎖呼び出し）
Class.       ; → シンボル（コンストラクタ）
```

### 10.4 数値の先頭ゼロ

```clojure
0            ; → 0
00           ; → エラー（無効な八進）
07           ; → 7（八進）
08           ; → エラー（無効な八進）
0x1F         ; → 31（十六進）
```

### 10.5 キーワードのコロン

```clojure
:foo         ; → :foo
::foo        ; → :current-ns/foo
:::foo       ; → エラー
:foo:bar     ; → :foo:bar（有効だが非推奨）
```

---

## 11. 実装チェックリスト

### Phase 1: 基本トークン

- [ ] 整数（十進、十六進、八進、基数）
- [ ] 浮動小数点
- [ ] 文字列（エスケープシーケンス含む）
- [ ] 文字リテラル
- [ ] シンボル
- [ ] キーワード
- [ ] リスト `()`
- [ ] ベクトル `[]`
- [ ] マップ `{}`

### Phase 2: リーダーマクロ

- [ ] Quote `'`
- [ ] Deref `@`
- [ ] Meta `^`
- [ ] Comment `;`

### Phase 3: ディスパッチマクロ

- [ ] セット `#{}`
- [ ] 正規表現 `#""`
- [ ] Var `#'`
- [ ] 無名関数 `#()`
- [ ] フォーム破棄 `#_`
- [ ] 特殊数値 `##Inf`, `##-Inf`, `##NaN`

### Phase 4: 高度な機能

- [ ] Syntax Quote `` ` ``
- [ ] Unquote `~`
- [ ] Unquote-splicing `~@`
- [ ] 自動解決キーワード `::`
- [ ] 名前空間マップ `#:`
- [ ] 条件読み込み `#?`
- [ ] BigInt `N`
- [ ] BigDecimal `M`
- [ ] Ratio `/`

### Phase 5: タグ付きリテラル

- [ ] `#inst`
- [ ] `#uuid`
- [ ] カスタムタグ

---

## 12. テストケース案

各トークンに対して:
1. 正常系（有効なパターン）
2. 境界値（最小/最大）
3. エラー系（無効なパターン）

```clojure
;; 数値テスト
(assert (= 42 42))
(assert (= 0x2A 42))
(assert (= 2r101010 42))
(assert (= 22/7 (/ 22 7)))

;; 文字列テスト
(assert (= "hello" "hello"))
(assert (= "a\nb" "a\nb"))
(assert (= "\u0041" "A"))

;; コレクションテスト
(assert (= '(1 2 3) (list 1 2 3)))
(assert (= [1 2 3] (vector 1 2 3)))
(assert (= {:a 1} (hash-map :a 1)))
(assert (= #{1 2 3} (set [1 2 3])))
```

---

## 次のステップ

1. [ ] ClojureWasmAlphaの現在のReader実装との差分確認
2. [ ] 未対応トークンのリストアップ
3. [ ] テストケース作成（トークン単位）
4. [ ] status/tokens.yaml作成
